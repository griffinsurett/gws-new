---
// src/components/ContentRenderer/variants/MenuVariant.astro
/**
 * Menu Variant - Responsive Navigation Menu
 *
 * Now expects items to be passed with potential parent relationships.
 * Builds tree structure from flat items.
 *
 * Mobile menu uses deferred hydration:
 * 1. Static hamburger button renders immediately (no JS)
 * 2. Menu content lazy-loads only when button is clicked
 */

import type { BaseVariantProps } from "../ContentRenderer.types";
import MenuList from "@/components/LoopTemplates/Menu/MenuList.astro";
import StaticHamburgerButton from "@/components/Menu/StaticHamburgerButton.astro";
import LazyHamburgerMenu from "@/components/LoopTemplates/Menu/HamburgerMenu/Lazy";
import { buildMenuTree } from "@/utils/menuQueries";
import { toArray } from "@/utils/array";

type MenuMode = "responsive" | "flat-only" | "hamburger-only";

interface Props extends BaseVariantProps {
  maxDepth?: number;
  mode?: MenuMode;
  closeButton?: boolean;
  hamburgerTransform?: boolean;
}

const {
  items = [],
  className = "",
  id,
  maxDepth = 3,
  mode = "responsive",
  closeButton = false,
  hamburgerTransform = true,
} = Astro.props as Props;

const safeItems = toArray(items);

// Build hierarchical tree from flat items
const menuTree = buildMenuTree(safeItems);

// Determine which versions to show based on mode
const showDesktop = mode === "responsive" || mode === "flat-only";
const showMobile = mode === "responsive" || mode === "hamburger-only";

// Responsive visibility classes
const desktopClasses = mode === "responsive" ? "hidden md:block" : "";
const mobileClasses = showMobile && mode === "responsive" ? "md:hidden" : "";

// Generate unique button ID for this menu instance
const buttonId = id ? `${id}-menu-toggle` : "mobile-menu-toggle";
---

<div id={id} class={`menu-variant ${className}`}>
  {
    showDesktop && (
      <nav
        class={`menu-desktop ${desktopClasses}`}
        aria-label="Main navigation"
      >
        <MenuList items={menuTree} level={0} />
      </nav>
    )
  }

  {
    showMobile && (
      <div class={`menu-mobile ${mobileClasses}`}>
        {/* Static button - no JS required for initial render */}
        <StaticHamburgerButton id={buttonId} />

        {/* Lazy-loaded menu - only hydrates on first click */}
        <LazyHamburgerMenu
          client:idle
          items={menuTree}
          buttonId={buttonId}
          closeButton={closeButton}
          hamburgerTransform={hamburgerTransform}
        />
      </div>
    )
  }
</div>
