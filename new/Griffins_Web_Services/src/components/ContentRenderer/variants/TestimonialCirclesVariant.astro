---
import { Image } from "astro:assets";
import CSSCounter from "@/components/CSSCounter.astro";
import Heading from "@/components/Heading";
import Placeholder from "@/assets/placeholder.jpg";
import type { BaseVariantProps } from "../ContentRenderer.types";
import { toArray } from "@/utils/array";
import { resolveImageMetadata, getImageAlt } from "@/utils/images";

interface Props extends BaseVariantProps {
  counterStart?: number;
  counterEnd?: number;
  counterDuration?: number;
  counterDecimals?: number;
  counterPrefix?: string;
  counterSuffix?: string;
  counterLabel?: string;
  counterClassName?: string;
  link?: string;
}

const {
  items = [],
  className = "",
  counterStart = 1,
  counterEnd = 100,
  counterDuration = 2000,
  counterDecimals,
  counterPrefix = "",
  counterSuffix = "+",
  counterLabel = "Happy Clients",
  counterClassName = "text-heading m-0 p-0 text-3xl lg:text-4xl",
  link = "/#testimonials-home",
  id,
} = Astro.props as Props;

const safeItems = toArray(items);
const faces = safeItems.slice(0, 3);
if (faces.length === 0) {
  return;
}

const resolveImage = (face: any) => {
  const featured = face.featuredImage;
  const metadata = resolveImageMetadata(featured);

  if (metadata) {
    const alt = getImageAlt(featured, face.author ?? "Testimonial");
    return { src: metadata, alt };
  }

  return { src: Placeholder, alt: face.author ?? "Testimonial" };
};
---

<a
  id={id}
  href={link}
  class={`testimonials flex items-center gap-4 lg:gap-6 px-2 md:px-0 ${className}`.trim()}
>
  <div class="flex justify-center items-center">
    {faces.map((face) => (
      <div class="circle -mr-2 lg:-mr-4 first:ml-0 w-9 h-9 sm:w-10 sm:h-10 lg:w-12 lg:h-12 rounded-full overflow-hidden shrink-0 flex items-center justify-center">
        {(() => {
          const resolved = resolveImage(face);
          return (
            <Image
              src={resolved.src}
              alt={resolved.alt}
              widths={[56]}
              class="object-cover w-full h-full"
              fetchpriority="high"
              loading="eager"
            />
          );
        })()}
      </div>
    ))}
  </div>

  <div class="flex flex-col items-start">
    <Heading tagName="span" className={counterClassName}>
      <CSSCounter
        start={counterStart}
        end={counterEnd}
        duration={counterDuration}
        prefix={counterPrefix}
        suffix={counterSuffix}
        className="leading-none"
      />
    </Heading>
    <Heading tagName="p" className="small-text m-0">
      {counterLabel}
    </Heading>
  </div>
</a>

<script is:inline>
  (function() {
    if (window.__testimonialsPulseInitialized) return;
    window.__testimonialsPulseInitialized = true;

    const initTestimonialsPulse = () => {
      const circles = document.querySelectorAll(".testimonials .circle");
      if (!circles.length) return;

      let idx = 0;
      const pulse = () => {
        const prev = (idx - 1 + circles.length) % circles.length;
        circles[prev]?.classList.remove("heartbeat");
        circles[idx]?.classList.add("heartbeat");
        idx = (idx + 1) % circles.length;
      };

      pulse();
      setInterval(pulse, 1600);
    };

    if ("requestIdleCallback" in window) {
      requestIdleCallback(initTestimonialsPulse);
    } else {
      window.addEventListener("load", initTestimonialsPulse, { once: true });
    }
  })();
</script>
